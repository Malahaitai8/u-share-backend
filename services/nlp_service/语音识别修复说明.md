# 语音识别录音功能修复说明

## 问题描述

在电脑上测试时，直接录音转文字功能无法正常工作，但上传语音文件可以正常识别。

## 问题原因

1. **前端录音格式**：浏览器 `MediaRecorder` API 默认生成 `audio/webm` 格式
2. **后端限制**：百度语音识别 API 不直接支持 webm 格式
3. **格式不匹配**：导致录音后无法被正确识别

## 解决方案

### 1. 后端修改（已完成）✅

**修改文件：** `services/nlp_service/app/main.py`

#### 新增功能：
- ✅ 添加音频格式自动转换功能（webm → wav）
- ✅ 使用 `pydub` 库进行音频处理
- ✅ 支持多种音频格式：webm, ogg, mp3, wav, m4a
- ✅ 自动检测格式并转换
- ✅ 添加详细的日志记录

#### 新增依赖：
```python
pydub          # 音频处理库
ffmpeg-python  # ffmpeg Python绑定（pydub依赖）
```

#### 核心代码：
```python
def convert_audio_to_wav(audio_bytes: bytes, source_format: str) -> tuple[bytes, int]:
    """
    将音频转换为 WAV 格式（百度 ASR 支持的格式）
    - 自动转换为单声道
    - 设置采样率为 16kHz
    - 设置位深度为 16位
    """
    # ... 转换逻辑 ...
```

#### 支持的格式：
| 输入格式 | 是否需要转换 | 输出格式 |
|---------|------------|---------|
| webm | ✅ 需要 | wav |
| ogg | ✅ 需要 | wav |
| mp3 | ✅ 需要 | wav |
| opus | ✅ 需要 | wav |
| wav | ❌ 不需要 | wav |
| m4a | ❌ 不需要 | m4a |

### 2. 前端优化（已完成）✅

**修改文件：** `u-share-frontend/src/views/GarbageClassification/VoiceRecognition.vue`

#### 改进内容：
- ✅ 创建 File 对象时指定明确的文件名（`.webm` 扩展名）
- ✅ 添加录音信息日志输出
- ✅ 确保正确调用 `mediaRecorder.stop()`

#### 修改代码：
```javascript
// 创建 File 对象，指定文件名（后端会根据扩展名判断格式）
const audioFile = new File([audioBlob], `recording_${Date.now()}.webm`, { 
  type: 'audio/webm' 
})

console.log('录音完成:', {
  size: audioFile.size,
  type: audioFile.type,
  name: audioFile.name,
  duration: `${(duration / 1000).toFixed(1)}秒`
})
```

## 部署步骤

### 1. 安装系统依赖（重要）⚠️

**pydub 需要 ffmpeg** 作为后端音频处理工具。

#### Windows 系统：
```powershell
# 方法1: 使用 Chocolatey
choco install ffmpeg

# 方法2: 手动安装
# 1. 从 https://www.gyan.dev/ffmpeg/builds/ 下载 ffmpeg
# 2. 解压到某个目录，如 C:\ffmpeg
# 3. 将 C:\ffmpeg\bin 添加到系统环境变量 PATH
```

#### macOS 系统：
```bash
brew install ffmpeg
```

#### Linux 系统（Ubuntu/Debian）：
```bash
sudo apt update
sudo apt install ffmpeg
```

#### Docker 部署：
在 Dockerfile 中添加：
```dockerfile
# 安装 ffmpeg
RUN apt-get update && apt-get install -y ffmpeg
```

### 2. 安装 Python 依赖

```bash
cd services/nlp_service
pip install -r requirements.txt
```

或在 Docker 中会自动安装（确保 Dockerfile 包含 ffmpeg 安装）

### 3. 验证安装

```bash
# 验证 ffmpeg 是否安装成功
ffmpeg -version

# 启动服务测试
uvicorn app.main:app --reload --port 8002
```

## 工作流程

```
用户点击录音按钮
    ↓
浏览器 MediaRecorder 开始录音
    ↓
用户说话："塑料瓶"
    ↓
点击停止，生成 audio/webm 文件
    ↓
前端创建 File 对象（recording_xxx.webm）
    ↓
上传到后端 /nlp/recognize/voice
    ↓
后端检测格式：webm
    ↓
调用 convert_audio_to_wav()
    ↓
pydub + ffmpeg 转换：webm → wav
    ↓
设置音频参数：单声道、16kHz、16位
    ↓
转换后的 wav 数据传给百度 ASR
    ↓
百度识别返回文字："塑料瓶"
    ↓
文字分类：可回收物
    ↓
返回给前端显示
```

## 兼容性说明

### 浏览器支持

| 浏览器 | MediaRecorder | webm支持 | 录音功能 |
|-------|--------------|---------|---------|
| Chrome/Edge | ✅ | ✅ | ✅ 完全支持 |
| Firefox | ✅ | ✅ | ✅ 完全支持 |
| Safari | ⚠️ | ❌ | ⚠️ 可能生成其他格式 |
| 移动浏览器 | ✅ | ✅ | ✅ 完全支持 |

**注意：**
- Safari 可能使用 mp4/m4a 格式，后端也支持
- 需要用户授权麦克风权限
- 建议使用 HTTPS 协议

### 系统要求

- **后端**：需要安装 ffmpeg
- **前端**：现代浏览器，支持 MediaRecorder API
- **网络**：HTTPS（浏览器要求）

## 测试方法

### 1. 本地测试

```bash
# 启动后端服务
cd services/nlp_service
uvicorn app.main:app --reload --port 8002

# 访问前端
# 进入语音识别页面
# 点击麦克风按钮
# 允许麦克风权限
# 说话后点击停止
# 查看识别结果
```

### 2. 查看日志

后端会输出详细日志：
```
INFO: 收到音频文件: filename=recording_1699xxx.webm, content_type=audio/webm, size=45678
INFO: 检测到 webm 格式，需要转换为 WAV
INFO: 正在转换音频格式: webm -> wav
INFO: 音频转换成功: 原始大小=45678, WAV大小=123456
INFO: 识别成功: 塑料瓶
```

### 3. 常见问题排查

#### 问题1: "pydub.exceptions.CouldntDecodeError"
**原因**：ffmpeg 未安装或不在 PATH 中
**解决**：
```bash
# 检查 ffmpeg
ffmpeg -version

# 如果没有，按上面的步骤安装
```

#### 问题2: "无法访问麦克风"
**原因**：浏览器权限或协议问题
**解决**：
- 确保使用 HTTPS 协议
- 检查浏览器麦克风权限设置
- 尝试不同的浏览器

#### 问题3: "音频格式转换失败"
**原因**：音频数据损坏或格式特殊
**解决**：
- 检查录音时长（至少0.5秒）
- 查看后端日志获取详细错误
- 尝试不同的浏览器录音

#### 问题4: "识别失败: 3302"
**原因**：百度 API 权限问题
**解决**：
- 检查百度 API Key 是否正确
- 确认账号是否有语音识别权限
- 查看百度控制台的接口调用情况

## 性能优化

### 1. 文件大小
- webm 格式通常较小（1秒约10-20KB）
- 转换为 wav 后会增大（1秒约32KB）
- 建议限制录音时长（如60秒以内）

### 2. 转换速度
- webm → wav 转换通常很快（<1秒）
- 主要耗时在百度 ASR 识别（2-5秒）

### 3. 临时文件
- 转换过程会创建临时文件
- 转换完成后自动清理
- 不会占用大量磁盘空间

## 后续改进建议

- [ ] 添加音频格式选择（让用户选择录音格式）
- [ ] 支持更多浏览器（Safari 优化）
- [ ] 添加音频质量检测（静音、噪音过大等）
- [ ] 实现音频压缩（减少上传数据量）
- [ ] 添加录音可视化（波形显示）
- [ ] 支持实时识别（边说边识别）

## 总结

✅ **现在已经支持电脑端直接录音转文字功能**

修改后的系统：
1. 自动检测音频格式
2. 自动转换为百度 ASR 支持的格式
3. 提供详细的错误日志
4. 兼容多种浏览器和设备

**重要提醒**：部署时务必安装 ffmpeg！




